#!/bin/bash -eux

function close_bbl_ssh_connection() {
  # Kill all ssh connections on exit.
  # This is needed so that tasks using bbl print-env in a credhub environment
  # don't hang after the script is finished.
  pkill ssh || true
}

function setup_bosh_env_vars() {
  set +ux
  pushd env-repo/"${BBL_STATE_DIR}"
    eval "$(bbl print-env)"
  popd
  set -ux
}

trap close_bbl_ssh_connection EXIT

ls ${BBL_STATE_DIR}
VAR_STORE=env-repo/bbl-state/vars/director-vars-store.yml
CREDHUB_PASSWORD=$(bosh int ${VAR_STORE} --path /credhub_cli_password)

CREDHUB_API="${CREDHUB_SERVER}"
echo "Connecting to ${CREDHUB_API}"

STATE=env-repo/bbl-state/vars/terraform.tfstate
terraform output -state=${STATE}

bosh int ${VAR_STORE} --path /credhub_tls/certificate > credhub.cert
bosh int ${VAR_STORE} --path /uaa_ssl/certificate > uaa.cert

setup_bosh_env_vars

credhub api --server ${CREDHUB_API} --ca-cert=uaa.cert --ca-cert=credhub.cert
credhub login -u credhub-cli -p ${CREDHUB_PASSWORD}

credhub show
